version: 6.0.0
session: 685c63558f43d1527c84d053
steps:
  # Start the instance and install APK
  - prompt: Download and Start APK
    commands:
      - command: exec
        lang: pwsh
        code: |
          # Authenticate Gmsaas 
          gmsaas auth token ${TD_GENYMOTION_KEY}
          gmsaas config set android-sdk-path C:\Android

          # Start instance, with name 'td-test'
          $instance=$(gmsaas instances start 3990323a-1e9a-49df-ad87-6947f7fc166e td-test)
          gmsaas instances adbconnect $instance

          # Save Instance ID and echo value
          Write-Output $instance | Out-File -FilePath C:\instance_id
          Write-Output "Instance ID: $instance"

          # Get Display Link
          gmsaas instances display -y $instance
          $clipboard = Get-Clipboard
          $escapedUrl = '"' + $clipboard + '"'

          # Open Chrome to Emulator
          Start-Process 'C:/Program Files/Google/Chrome/Application/chrome.exe' -ArgumentList '--start-maximized',$escapedUrl

      - command: exec
        lang: pwsh
        code: |
          # Download + install APK via cmd
          $apk_url = "https://v6-demo-assets.s3.us-east-2.amazonaws.com/todo-1-0-0.apk"
          Start-Process cmd.exe -ArgumentList "/c curl -o C:\app.apk $apk_url && adb install C:\app.apk"

          # Get Package name
          $output = & 'C:\Android\build-tools\36.0.0\aapt.exe' dump badging C:\app.apk
          $package = ($output | Select-String "package: name='([^']+)'" ).Matches.Groups[1].Value

          # Launch Application via cmd
          Start-Process cmd.exe -ArgumentList "/c adb shell monkey -p $package -c android.intent.category.LAUNCHER 1"

      # Make Sure Window is open
      - command: wait-for-text
        text: gmsaas
        timeout: 60000
