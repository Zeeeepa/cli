# Setup and Teardown in TestDriver.ai Workflows

When running tests with **TestDriver.ai** in GitHub Actions, it's important to handle **setup** and **teardown** tasks properly. Setup tasks should be performed **before** the TestDriver.ai action (e.g., creating a new user via an API), and teardown tasks should be performed **after** the TestDriver.ai action, ensuring cleanup happens regardless of the test results.

This guide explains how to structure your workflow to handle setup and teardown tasks effectively.

---

## Workflow Overview

1. **Setup Tasks**:
   - Use a dedicated action **before** the TestDriver.ai action to prepare the environment (e.g., create a test user via an API).
   - Pass the created user credentials to the TestDriver.ai action using environment variables.

2. **Run Tests**:
   - Execute the tests using TestDriver.ai, leveraging the setup data (e.g., the test user).

3. **Teardown Tasks**:
   - Use a dedicated action **after** the TestDriver.ai action to clean up (e.g., delete the test user).
   - Ensure the teardown step runs **no matter the result** of the TestDriver.ai action.

---

## Example Workflow with Setup and Teardown

### Workflow File: `.github/workflows/testdriver-setup-teardown.yml`

```yaml
name: TestDriver.ai with Setup and Teardown

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  test:
    name: "TestDriver with Setup and Teardown"
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository
      - name: Check out repository
        uses: actions/checkout@v2

      # Step 2: Setup - Create a test user via API
      - name: Setup Test User
        id: setup-user
        run: |
          echo "Creating test user via API..."
          RESPONSE=$(curl -X POST -H "Content-Type: application/json" -d '{"name": "Test User", "email": "test@example.com", "password": "password123"}' https://api.example.com/users)
          echo "USER_ID=$(echo $RESPONSE | jq -r '.id')" >> $GITHUB_ENV
          echo "USER_EMAIL=$(echo $RESPONSE | jq -r '.email')" >> $GITHUB_ENV
          echo "USER_PASSWORD=password123" >> $GITHUB_ENV
        env:
          API_KEY: ${{ secrets.API_KEY }}

      # Step 3: Run Tests with TestDriver.ai
      - name: Run Tests with TestDriver.ai
        uses: testdriverai/action@main
        with:
          key: ${{ secrets.TESTDRIVER_API_KEY }}
          prompt: |
            1. Log in with the test user
            2. Perform actions on the dashboard
          prerun: |
            echo "Launching browser with test user credentials..."
            echo "Email: $USER_EMAIL"
            echo "Password: $USER_PASSWORD"
        env:
          USER_EMAIL: ${{ env.USER_EMAIL }}
          USER_PASSWORD: ${{ env.USER_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_COLOR: "3"

      # Step 4: Teardown - Delete the test user
      - name: Teardown Test User
        if: always()
        run: |
          echo "Deleting test user via API..."
          curl -X DELETE -H "Authorization: Bearer ${{ secrets.API_KEY }}" https://api.example.com/users/$USER_ID
          echo "Test user deleted."
        env:
          USER_ID: ${{ env.USER_ID }}
          API_KEY: ${{ secrets.API_KEY }}```


---

## Workflow Steps Explained

### 1. **Setup Test User**
- **Purpose**: Create a test user via an API before running the tests.
- **How It Works**:
  - The `Setup Test User` step sends a `POST` request to the API to create a new user.
  - The user ID, email, and password are extracted from the API response and stored as environment variables (`USER_ID`, `USER_EMAIL`, `USER_PASSWORD`).
- **Example Output**:
  - `USER_ID`: `12345`
  - `USER_EMAIL`: `test@example.com`
  - `USER_PASSWORD`: `password123`

---

### 2. **Run Tests with TestDriver.ai**
- **Purpose**: Execute tests using the TestDriver.ai action.
- **How It Works**:
  - The `USER_EMAIL` and `USER_PASSWORD` environment variables are passed to the `prerun` script.
  - The test prompts use these credentials to log in and perform actions.

---

### 3. **Teardown Test User**
- **Purpose**: Delete the test user via an API after the tests are complete.
- **How It Works**:
  - The `Teardown Test User` step sends a `DELETE` request to the API to remove the test user.
  - The `if: always()` condition ensures this step runs even if the TestDriver.ai action fails.

---

## Best Practices for Setup and Teardown

1. **Use APIs for Setup and Teardown**:
   - Use APIs to create and delete test data dynamically, ensuring a clean environment for each test run.

2. **Pass Data via Environment Variables**:
   - Store setup data (e.g., user credentials) in environment variables and pass them to the TestDriver.ai action.

3. **Ensure Teardown Always Runs**:
   - Use `if: always()` to ensure teardown tasks are executed regardless of the test results.

4. **Log Setup and Teardown Steps**:
   - Add `echo` statements to log the progress of setup and teardown tasks for easier debugging.

5. **Test Locally**:
   - Verify setup and teardown scripts locally before integrating them into the workflow.

---

## Example Use Cases

### 1. **User Management**
- Create a test user during setup.
- Delete the test user during teardown.

### 2. **Database Operations**
- Insert test data into a database during setup.
- Remove the test data during teardown.

### 3. **Mock Services**
- Start a mock API server during setup.
- Stop the mock server during teardown.

---

By structuring your workflow to handle **setup** before the TestDriver.ai action and **teardown** after it, you can ensure a clean and reliable test environment for every run. This approach also ensures that teardown tasks are executed regardless of the test results, maintaining a consistent state for subsequent runs.
