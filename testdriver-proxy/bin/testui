#!/usr/bin/env node

const { spawn } = require('child_process');
const path = require('path');
const http = require('http');
const fs = require('fs');
const axios = require('axios');
const yaml = require('js-yaml');
const os = require('os');

const INSTALL_DIR = path.join(__dirname, '..');
const TEST_APP_DIR = path.join(INSTALL_DIR, 'tests', 'ui', 'test-app');
const SERVER_SCRIPT = path.join(INSTALL_DIR, 'server.js');
const TEMP_DIR = path.join(os.tmpdir(), 'testui-temp');

const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m'
};

function log(color, msg) {
  console.log(colors[color] + msg + colors.reset);
}

function parseArgs() {
  const args = process.argv.slice(2);
  const parsed = {
    prompt: null,
    testFile: null,
    appUrl: null
  };

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    if (arg.startsWith('--prompt=') || arg.startsWith('PROMPT=')) {
      parsed.prompt = arg.split('=')[1].replace(/^["']|["']$/g, '');
    } else if (arg.startsWith('--file=') || arg.startsWith('TEST=') || arg.startsWith('FILE=')) {
      parsed.testFile = arg.split('=')[1].replace(/^["']|["']$/g, '');
    } else if (arg.startsWith('--app=') || arg.startsWith('APP=')) {
      parsed.appUrl = arg.split('=')[1].replace(/^["']|["']$/g, '');
    } else if (!arg.startsWith('-') && !parsed.prompt && !parsed.testFile) {
      // Default positional argument is prompt
      parsed.prompt = arg;
    }
  }

  return parsed;
}

function showHelp() {
  log('cyan', '\n╔════════════════════════════════════════════╗');
  log('cyan', '║  TestUI - AI Agent Test Execution         ║');
  log('cyan', '╚════════════════════════════════════════════╝\n');
  
  console.log('Usage:');
  console.log('  testui --prompt="your natural language test"');
  console.log('  testui --file="path/to/test.yaml"');
  console.log('  testui "natural language shorthand"\n');
  
  console.log('Examples:');
  console.log('  # Natural language prompt (generates YAML via AI)');
  console.log('  testui --prompt="click the login button and verify"');
  console.log('  testui "click all buttons"  # Shorthand\n');
  
  console.log('  # Direct YAML file execution');
  console.log('  testui --file="tests/login-test.yaml"');
  console.log('  testui FILE="tests/checkout.yaml"\n');
  
  console.log('  # With external app');
  console.log('  testui --app="http://localhost:3000" --prompt="test checkout"\n');
  
  console.log('How it works:');
  console.log('  --prompt: Sends prompt to /api/:version/testdriver/input');
  console.log('            Generates YAML automatically, then runs it');
  console.log('  --file:   Runs existing YAML test file directly\n');
  
  console.log('Environment Variables:');
  console.log('  ANTHROPIC_API_KEY    - Your API key (required)');
  console.log('  TESTUI_PROXY_PORT    - Proxy server port (default: 9876)');
  console.log('  APP_URL              - Override default test app URL');
  console.log('  TD_API_ROOT          - Auto-set to proxy URL\n');
  
  console.log('Model Configuration:');
  console.log('  Default Model: glm-4.5V');
  console.log('  Override with: MODEL=your-model testui ...\n');
  
  process.exit(0);
}

function checkPort(port) {
  return new Promise((resolve) => {
    const server = http.createServer();
    server.once('error', () => resolve(true));
    server.once('listening', () => {
      server.close();
      resolve(false);
    });
    server.listen(port);
  });
}

async function generateYAMLFromPrompt(prompt, proxyPort) {
  log('cyan', '\n🤖 Generating test YAML from prompt...');
  log('magenta', `   📝 "${prompt}"\n`);
  
  try {
    const response = await axios.post(`http://localhost:${proxyPort}/api/v1/testdriver/input`, {
      input: prompt,
      screenshot: '',
      mousePosition: { x: 0, y: 0 },
      activeWindow: 'TestUI',
      stream: false
    }, {
      timeout: 30000,
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.data && response.data.commands) {
      // Convert commands to YAML format
      const yamlContent = yaml.dump({
        name: 'Generated Test from Prompt',
        description: prompt,
        steps: response.data.commands
      });
      
      // Save to temp file
      if (!fs.existsSync(TEMP_DIR)) {
        fs.mkdirSync(TEMP_DIR, { recursive: true });
      }
      
      const tempFile = path.join(TEMP_DIR, `test-${Date.now()}.yaml`);
      fs.writeFileSync(tempFile, yamlContent);
      
      log('green', `✅ Generated YAML test file: ${tempFile}`);
      log('cyan', '\nGenerated test steps:');
      console.log(yamlContent);
      
      return tempFile;
    } else {
      throw new Error('Invalid response from proxy /input endpoint');
    }
  } catch (error) {
    log('red', `❌ Failed to generate YAML: ${error.message}`);
    if (error.response) {
      log('yellow', `   Response status: ${error.response.status}`);
      log('yellow', `   Response data: ${JSON.stringify(error.response.data)}`);
    }
    throw error;
  }
}

async function startTestUI(options) {
  log('cyan', '\n╔════════════════════════════════════════════╗');
  log('cyan', '║  TestUI - AI Agent Test Execution         ║');
  log('cyan', '╚════════════════════════════════════════════╝\n');
  
  // Validate API key
  if (!process.env.ANTHROPIC_API_KEY && !process.env.API_KEY) {
    log('red', '❌ ANTHROPIC_API_KEY environment variable not set!');
    log('yellow', '\n📝 Set your API key:');
    log('cyan', '   export ANTHROPIC_API_KEY="your-api-key"\n');
    process.exit(1);
  }
  
  const startOwnApp = !options.appUrl;
  let testApp, proxyServer;
  let generatedTestFile = null;
  
  // Determine proxy port (allow override via environment)
  const proxyPort = parseInt(process.env.TESTUI_PROXY_PORT || process.env.PORT || '9876');
  
  try {
    // Start test app if needed
    if (startOwnApp) {
      const testAppServer = path.join(TEST_APP_DIR, 'server.js');
      if (!fs.existsSync(testAppServer)) {
        log('red', '❌ Test app not found at: ' + testAppServer);
        process.exit(1);
      }
      
      log('cyan', '1️⃣  Starting test UI app (port 4000)...');
      testApp = spawn('node', [testAppServer], {
        cwd: TEST_APP_DIR,
        stdio: ['ignore', 'pipe', 'pipe']
      });
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const testAppReady = await checkPort(4000);
      if (!testAppReady) {
        log('red', '❌ Failed to start test app on port 4000');
        testApp.kill();
        process.exit(1);
      }
      log('green', '✅ Test app ready at http://localhost:4000');
    } else {
      log('blue', `🌐 Using external app: ${options.appUrl}`);
    }
    
    // Start proxy server
    log('cyan', `\n2️⃣  Starting proxy server (port ${proxyPort})...`);
    proxyServer = spawn('node', [SERVER_SCRIPT], {
      cwd: INSTALL_DIR,
      env: { 
        ...process.env, 
        PORT: String(proxyPort),
        ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY || process.env.API_KEY
      },
      stdio: ['ignore', 'pipe', 'pipe']
    });
    
    await new Promise(resolve => setTimeout(resolve, 3000));
  
    const proxyReady = await checkPort(proxyPort);
    if (!proxyReady) {
      log('red', `❌ Failed to start proxy server on port ${proxyPort}`);
      if (testApp) testApp.kill();
      proxyServer.kill();
      process.exit(1);
    }
    log('green', `✅ Proxy server ready at http://localhost:${proxyPort}`);
    
    // Set TD_API_ROOT to proxy server URL
    const tdApiRoot = `http://localhost:${proxyPort}`;
    process.env.TD_API_ROOT = tdApiRoot;
    log('blue', `🔗 TD_API_ROOT set to: ${tdApiRoot}`);
    
    // Determine test execution method
    const appUrl = options.appUrl || 'http://localhost:4000';
    let testFilePath;
    
    if (options.testFile) {
      // Direct YAML file execution
      log('cyan', `\n3️⃣  Running test from file: ${options.testFile}\n`);
      testFilePath = options.testFile;
    } else if (options.prompt) {
      // Generate YAML from prompt using /input endpoint
      log('cyan', '\n3️⃣  Processing natural language prompt...\n');
      testFilePath = await generateYAMLFromPrompt(options.prompt, proxyPort);
      generatedTestFile = testFilePath;
    } else {
      log('red', '❌ No test specified! Provide --prompt or --file parameter.');
      if (testApp) testApp.kill();
      proxyServer.kill();
      process.exit(1);
    }
    
    log('blue', '\n─────────────────────────────────────────────');
    log('cyan', `\n🚀 Executing test: ${path.basename(testFilePath)}\n`);
    log('blue', '─────────────────────────────────────────────\n');
    
    // Run testdriverai with the YAML file
    const testDriver = spawn('npx', ['--yes', 'testdriverai@latest', 'run', testFilePath], {
      env: { 
        ...process.env, 
        TD_API_ROOT: tdApiRoot,
        ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY || process.env.API_KEY
      },
      stdio: 'inherit'
    });
    
    testDriver.on('exit', (code) => {
      log('blue', '\n─────────────────────────────────────────────');
      log('yellow', '\n🧹 Cleaning up...');
      if (testApp) testApp.kill();
      proxyServer.kill();
      
      // Clean up generated test file
      if (generatedTestFile && fs.existsSync(generatedTestFile)) {
        try {
          fs.unlinkSync(generatedTestFile);
          log('cyan', `   Removed temp file: ${path.basename(generatedTestFile)}`);
        } catch (e) {
          // Ignore cleanup errors
        }
      }
      
      if (code === 0) {
        log('green', '\n✅ Test completed successfully!\n');
      } else {
        log('red', '\n❌ Test failed with exit code: ' + code + '\n');
      }
      process.exit(code);
    });
    
    // Handle cleanup on interrupt
    process.on('SIGINT', () => {
      log('yellow', '\n\n⚠️  Interrupted! Cleaning up...');
      if (testApp) testApp.kill();
      proxyServer.kill();
      if (generatedTestFile && fs.existsSync(generatedTestFile)) {
        try {
          fs.unlinkSync(generatedTestFile);
        } catch (e) {
          // Ignore
        }
      }
      process.exit(130);
    });
    
  } catch (error) {
    log('red', '\n❌ Error: ' + error.message);
    if (error.stack) log('yellow', error.stack);
    if (testApp) testApp.kill();
    if (proxyServer) proxyServer.kill();
    if (generatedTestFile && fs.existsSync(generatedTestFile)) {
      try {
        fs.unlinkSync(generatedTestFile);
      } catch (e) {
        // Ignore
      }
    }
    process.exit(1);
  }
}

// Main execution
const args = parseArgs();

if (process.argv.length < 3 || process.argv.includes('--help') || process.argv.includes('-h')) {
  showHelp();
}

if (!args.prompt && !args.testFile) {
  log('red', '\n❌ No test specified!');
  log('yellow', '\nProvide either:');
  log('cyan', '  PROMPT="natural language test"');
  log('cyan', '  TEST="path/to/test.yaml"\n');
  log('yellow', 'Run with --help for more info\n');
  process.exit(1);
}

startTestUI(args).catch(err => {
  log('red', '\n❌ Error: ' + err.message);
  log('red', err.stack);
  process.exit(1);
});
